<div class="datatable-container">
  <!-- Header with title and actions -->
  <app-breadcrumb [titleBreadcrumbs]="breadcrumbTitle()"/>

  <!-- Search and Filter Controls -->
  <div class="table-controls">
    <!-- search component -->
    <app-searchbar [searchQuery]="searchQuery()" (onSearch)="getSearchQuery($event)"
    [searchItems]="searchByItems()"
    />

    <!-- Filter Bar -->
    <app-filterbar [selectedRole]="selectedRole()" (filterChange)="onFilterChange($event)"
      [sortBy]="sortBy()" (orderByChange)="getSortByFromChild($event)" 
      [filteredUsers]="filteredUsers().length" [totalUsers]="originalUsers().length"
      [filterBy]="filterBy()" [filterByItems]="filterByItems()"
      />

  <!-- Table Wrapper -->
  <div class="table-wrapper">
    <table class="datatable">
      <thead>
        @for(column of columns(); track $index){
          @let temp = column.col.toLowerCase();
          <th class="{{temp}}-col">
            <div class="th-content" (click)="sortByColumn(temp)">
              {{column.col.replaceAll('_',' ')}}
              @if(column.groupBy){
                <span class="sort-indicator" [class.active]="currentSort() === temp">‚ñº</span>
              }
            </div>
          </th>
        }
        <th class="actions-col">Actions</th>
      </thead>
      
      <!-- Loading State -->
      @if(isLoading()){
        <tbody>
          <tr class="loading-row">
            <td colspan="6">
              <div class="loading-spinner"></div>
              <div class="loading-text">Loading users...</div>
            </td>
          </tr>
        </tbody>
      }
      @else{
        <tbody>
          @for(user of paginatedUsers(); track $index){
            <tr>
              <!-- if name and surname available on this class -->
               @if(getFieldValue(user,'name') && getFieldValue(user,'surname')){
                <td class="name-col">
                  <div class="user-info">
                    <div class="avatar" [style.background]="getAvatarColor(getFieldValue(user,'name'))">
                      {{getFieldValue(user,'name').charAt(0)}}{{getFieldValue(user,'surname').charAt(0)}}
                    </div>
                    <div class="user-details">
                      <span class="user-name">{{getFieldValue(user,'name')}} {{getFieldValue(user,'surname')}}</span>
                      <span class="user-id">ID: {{1000 + $index}}</span>
                    </div>
                  </div>
                </td>
               }
              
               @for(col of columns(); track $index){
                @let temp = col.col.toLocaleLowerCase();
                @if(!(temp == 'name' && getFieldValue(user,'name') && getFieldValue(user,'surname'))){
                  <td class="{{temp}}-col">
                    @if(['phone','email'].includes(temp)){
                      @let sendTo = temp == 'phone' ? 'tel:': 'mailto:';
                      <a [href]="sendTo + getFieldValue(user,temp)" class="{{temp}}-link">
                      @if(getIcon(temp)){
                        <span class="icon">{{getIcon(temp)}}</span>
                      }
                      {{getFieldValue(user,temp)}}
                    </a>
                    }
                    @else if(temp == 'role'){
                      <span class="role-badge" [class]="getRoleClass(getFieldValue(user,temp))">
                        {{getFieldValue(user,temp)}}
                      </span>
                    }
                    @else if(getIcon(temp)) {
                        <span class="{{temp}}">
                            <span class="icon">{{getIcon(temp)}}</span>
                          {{getFieldValue(user,temp)}}
                        </span>
                    }@else {
                        <span class="address">
                          {{getFieldValue(user,temp)}}
                        </span>
                    }
                  </td>
                }
               }

            <td class="actions-col">
              <div class="action-buttons">
                <button class="action-btn edit-btn" [routerLink]="[`/${title().toLocaleLowerCase()}/${getFieldValue(user,'id')}`]" title="Edit">
                  <span class="btn-icon">‚úèÔ∏è</span>
                </button>
                <button class="action-btn delete-btn" (click)="deleteUser(user)" title="Delete">
                  <span class="btn-icon">üóëÔ∏è</span>
                </button>
                <button class="action-btn view-btn" (click)="viewUser(user)" title="View Details">
                  <span class="btn-icon">üëÅÔ∏è</span>
                </button>
              </div>
            </td>
            </tr>
          }
          <!-- No Results State -->
          @if(!filteredUsers().length){
            <tr>
            <td colspan="6" class="no-results">
              <div class="no-results-content">
                <span class="no-results-icon">üòï</span>
                <h3>No users found</h3>
                @if(searchQuery().length || selectedRole().length){
                  <p>No results match your search criteria. Try adjusting your filters.</p>
                }
                @if(!searchQuery().length && !selectedRole().length){
                  <p>No users available. Click "Add New" to create one.</p>
                }
                @if(searchQuery().length || selectedRole().length){
                  <button class="btn btn-secondary" (click)="clearFilters()">
                  Clear Filters
                </button>
                }
              </div>
            </td>
          </tr>
          }
        </tbody>
      }

      <!-- Data Rows -->
      
    </table>
  </div>

  <!-- Table Footer -->
  <div class="table-footer">
    <div class="footer-info">
      Showing {{filteredUsers().length}} of {{originalUsers().length}} entries
      
      @if(searchQuery()){
        <span class="search-info">
        ‚Ä¢ Searching for "{{searchQuery()}}"
      </span>
      }
    </div>
    <div class="pagination">
      <button class="pagination-btn" [disabled]="currentPage() === 1" (click)="previousPage()">
        <span class="btn-icon">‚óÄ</span> Previous
      </button>
      <span class="page-info">Page {{currentPage()}} of {{totalPages()}}</span>
      <button class="pagination-btn" [disabled]="currentPage === totalPages" (click)="nextPage()">
        Next <span class="btn-icon">‚ñ∂</span>
      </button>
    </div>
  </div>
</div>